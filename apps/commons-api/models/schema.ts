import {
  jsonb,
  pgTable,
  timestamp,
  uuid,
  text,
  integer,
  real,
  boolean as pgBoolean,
} from 'drizzle-orm/pg-core';
import { sql } from 'drizzle-orm';
import { ChatCompletionTool } from 'openai/resources/chat/completions';
import { WalletData } from '@coinbase/coinbase-sdk';

// agent table
export const agent = pgTable('agent', {
  agentId: text('agent_id')
    .default(sql`uuid_generate_v4()`)
    .primaryKey(),
  wallet: jsonb().notNull().$type<WalletData>(),
  instructions: text(),
  persona: text(),
  owner: text(),
  name: text().notNull(),
  knowledgebase: text(),
  externalTools: jsonb('external_tools').$type<string[]>(),
  commonTools: jsonb('common_tools').$type<string[]>(),
  temperature: real('temperature'),
  maxTokens: integer('max_tokens'),
  topP: real('top_p'),
  presencePenalty: real('presence_penalty'),
  frequencyPenalty: real('frequency_penalty'),
  stopSequence: jsonb('stop_sequence').$type<string[]>(),
  avatar: text(),

  // Liaison columns – we store only the hash of the liaison_key
  isLiaison: pgBoolean('is_liaison').default(false).notNull(),
  liaisonKeyHash: text('liaison_key'),
  externalUrl: text('external_url'),
  externalEndpoint: text('external_endpoint'),

  /* ▼ autonomous‑mode settings ▼ */
  autonomyEnabled: pgBoolean('autonomy_enabled').default(false).notNull(),
  autonomousIntervalSec: integer('autonomous_interval_sec').default(0), // 0 = off
  cronJobName: text('cron_job_name'),

  createdAt: timestamp('created_at', { withTimezone: true })
    .default(sql`timezone('utc', now())`)
    .notNull(),
});

//agent goal table
export const goal = pgTable('goal', {
  goalId: uuid('goal_id')
    .default(sql`uuid_generate_v4()`)
    .primaryKey(),
  agentId: text('agent_id').notNull(),
  sessionId: text('session_id'),

  title: text('title').notNull(),
  description: text('description'),

  status: text('status').default('pending').notNull(), // pending | in_progress | paused | completed | failed
  priority: integer('priority').default(0).notNull(),
  deadline: timestamp('deadline', { withTimezone: true }),
  progress: real('progress').default(0),
  isAutoGenerated: pgBoolean('is_auto_generated').default(false),
  metadata: jsonb('metadata').$type<Record<string, any>>(),

  createdAt: timestamp('created_at', { withTimezone: true })
    .default(sql`timezone('utc', now())`)
    .notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true })
    .default(sql`timezone('utc', now())`)
    .notNull(),
  completedAt: timestamp('completed_at', { withTimezone: true }),
});

// agent task table
export const task = pgTable('task', {
  taskId: uuid('task_id')
    .default(sql`uuid_generate_v4()`)
    .primaryKey(),
  agentId: text('agent_id').notNull(),
  goalId: uuid('goal_id').notNull(),

  title: text('title').notNull(),
  description: text('description'),

  status: text('status').default('pending').notNull(), // pending | in_progress | …
  priority: integer('priority').default(0).notNull(),

  scheduledStart: timestamp('scheduled_start', { withTimezone: true }),
  scheduledEnd: timestamp('scheduled_end', { withTimezone: true }),
  actualStart: timestamp('actual_start', { withTimezone: true }),
  actualEnd: timestamp('actual_end', { withTimezone: true }),

  estimatedDuration: integer('estimated_duration'),
  progress: real('progress').default(0),

  isRecurring: pgBoolean('is_recurring').default(false),
  context: jsonb('context').$type<Record<string, any>>(),
  tools: jsonb('tools').$type<string[]>(),
  metadata: jsonb('metadata').$type<Record<string, any>>(),
  summary: text('summary'),
  resultContent: jsonb('result_content').$type<any>(),

  createdAt: timestamp('created_at', { withTimezone: true })
    .default(sql`timezone('utc', now())`)
    .notNull(),
  updatedAt: timestamp('updated_at', { withTimezone: true })
    .default(sql`timezone('utc', now())`)
    .notNull(),
});

// agent task dependency table
export const taskDependency = pgTable('task_dependency', {
  id: uuid('id')
    .default(sql`uuid_generate_v4()`)
    .primaryKey(),
  dependentTaskId: uuid('dependent_task_id').notNull(),
  dependencyTaskId: uuid('dependency_task_id').notNull(),
  dependencyType: text('dependency_type').default('finish_to_start'),
  createdAt: timestamp('created_at', { withTimezone: true })
    .default(sql`timezone('utc', now())`)
    .notNull(),
});

// agent tool table
export const tool = pgTable('tool', {
  toolId: uuid('tool_id')
    .default(sql`uuid_generate_v4()`)
    .primaryKey(),

  // The "name" must match the function's "name" field
  name: text().notNull(),

  /**
   * The schema is a JSON column, and we’ll store:
   * - The "function" shape (name, description, parameters)
   * - The "apiSpec" that describes how to call the external API
   */
  schema: jsonb().notNull().$type<
    ChatCompletionTool & {
      apiSpec?: {
        baseUrl: string;
        path: string;
        method: string; // GET, POST, PUT, ...
        headers?: Record<string, string>;
        queryParams?: Record<string, string>;
        bodyTemplate?: any;
      };
    }
  >(),

  createdAt: timestamp('created_at', { withTimezone: true })
    .default(sql`timezone('utc', now())`)
    .notNull(),
});

export const resource = pgTable('resource', {
  resourceId: text('resource_id')
    .default(sql`uuid_generate_v4()`)
    .primaryKey(),

  resourceType: text('resource_type').notNull(),

  schema: jsonb('schema').notNull().$type<any>(),
  tags: jsonb().notNull().$type<string[]>(),
  resourceFile: text('resource_file').notNull(),

  createdAt: timestamp('created_at', { withTimezone: true })
    .default(sql`timezone('utc', now())`)
    .notNull(),
});

//session table
export const session = pgTable('session', {
  sessionId: uuid('session_id')
    .default(sql`uuid_generate_v4()`)
    .primaryKey(),
  model: jsonb(),
  query: jsonb(),
  history: jsonb(),

  createdAt: timestamp('created_at', { withTimezone: true })
    .default(sql`timezone('utc', now())`)
    .notNull(),
});

// agent log table
export const agentLog = pgTable('agent_log', {
  logId: uuid('log_id')
    .default(sql`uuid_generate_v4()`)
    .primaryKey(),
  agentId: text('agent_id').notNull(),
  sessionId: text('session_id'),
  action: text('action'),
  message: text('message'),
  status: text('status'),
  responseTime: integer('response_time'),
  tools: jsonb('tools').$type<
    Array<{
      name: string;
      status: string;
      summary?: string;
      duration?: number;
    }>
  >(),

  createdAt: timestamp('created_at', { withTimezone: true })
    .default(sql`timezone('utc', now())`)
    .notNull(),
});
